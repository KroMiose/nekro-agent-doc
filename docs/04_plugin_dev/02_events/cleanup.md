---
title: 清理环境
description: Nekro Agent 插件的清理机制，确保资源正确释放并恢复环境
---

# 清理环境

插件卸载或系统关闭时，需要清理资源并恢复环境。通过 `mount_cleanup_method` 装饰器注册清理方法：

```python
@plugin.mount_cleanup_method()
async def clean_up():
    """清理插件资源"""
    # 在此完成插件卸载时的清理工作
```

:::warning
清理方法是插件重载实现的重要依赖逻辑。如果没有正确清理资源，可能导致重载后的行为与预期不一致，出现全局变量冲突、资源占用、内存泄漏等问题，特别是在开发调试阶段频繁重载插件时尤为明显。
:::

:::tip
良好的清理机制是高质量插件的标志，它确保插件不会在卸载后留下资源占用问题或状态污染。
:::

清理方法的主要任务：

1. **释放资源**：关闭数据库连接、释放文件句柄等
2. **重置状态**：清空缓存、重置全局变量
3. **关闭连接**：断开与外部系统的连接
4. **恢复环境**：恢复被修改的环境设置

## 重载场景中的清理重要性

在开发和调试过程中，插件可能会被多次重载，此时清理方法的作用尤为重要：

1. **避免资源累积**：每次重载都会重新初始化插件，如果旧资源未被清理，会导致资源累积
2. **防止状态混乱**：全局变量和状态需要重置，否则新的插件实例可能会继承旧状态
3. **解除旧事件监听**：重载前需要移除旧的事件监听器，避免重复响应
4. **释放系统资源**：及时释放文件句柄、网络连接等系统资源，避免资源耗尽
