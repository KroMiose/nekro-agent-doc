---
title: 响应周期
description: Nekro Agent 插件的生命周期与响应流程，包括注册、初始化、交互和卸载各阶段的说明
---

# 响应周期

插件的生命周期与响应流程包括以下几个关键阶段：

1. **注册阶段**：插件在系统启动时被加载和注册。

2. **初始化阶段**：通过 `mount_init_method` 装饰器注册的方法在插件首次加载时执行。

3. **会话准备阶段**：每次会话开始前，系统会调用插件的提示词注入方法。

4. **沙盒执行阶段**：

   - 用户消息触发 AI 响应后，AI 生成的沙盒代码会在沙盒环境中执行
   - 沙盒代码可以调用插件的沙盒方法，这些方法通过 RPC 在主服务中执行
   - 方法的返回结果被传回沙盒环境，参与后续代码执行或中断进行迭代

5. **重置阶段**：当会话重置时，系统会调用插件的 `on_channel_reset` 方法。

6. **卸载阶段**：插件被禁用或系统关闭时，会调用插件的清理方法。

:::tip
插件开发者应确保正确处理各个生命周期阶段，特别是初始化和清理阶段，以避免资源泄漏。
:::

:::info
在沙盒执行阶段，AI 生成的 Python 代码会在隔离的沙盒环境中执行。插件向沙盒环境注入的沙盒方法可以被这些代码调用，但实际执行会通过 RPC 在主服务进程中完成，然后将结果返回给沙盒环境。
:::

```python
@plugin.mount_init_method()
async def init():
    """初始化阶段执行"""
    # 在插件首次加载时执行的代码

@plugin.mount_on_channel_reset()
async def on_channel_reset(_ctx: AgentCtx):
    """会话重置时执行"""
    # 当会话重置时执行的代码
```
